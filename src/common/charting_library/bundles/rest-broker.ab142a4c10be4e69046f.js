(window.webpackJsonp=window.webpackJsonp||[]).push([["rest-broker"],{"8Wzo":function(t,e,r){"use strict";var i;r.r(e),r.d(e,"StopType",(function(){return i})),function(t){t[t.StopLoss=0]="StopLoss",t[t.TrailingStop=1]="TrailingStop"}(i||(i={}))},E9hm:function(t,e,r){"use strict";r.d(e,"b",(function(){return i})),r.d(e,"a",(function(){return s}));var i={isSuspended:!1,supportDemoLiveSwitcher:!0,supportEditAmount:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyOrder:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0};function s(t){return Object.assign({},i,t)}},Uy0F:function(t,e,r){"use strict";r.r(e);var i,s=r("mrSG"),o=(r("bSeV"),r("8Wzo"),r("OekH")),n=(r("25b6"),r("YFKU"),[{label:window.t("Symbol"),className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:window.t("Side"),className:"",property:"side",formatter:"side"},{label:window.t("Type"),className:"",property:"type",formatter:"type"},{label:window.t("Qty"),className:"tv-data-table__cell--right-align",property:"qty",formatter:"formatQuantity",help:window.t("Size in lots")},{label:window.t("Filled Qty"),className:"tv-data-table__cell--right-align",property:"filledQty",formatter:"formatQuantity",help:window.t("Filled Size in lots")},{label:window.t("Limit Price"),className:"tv-data-table__cell--right-align",property:"limitPrice",formatter:"formatPrice"},{label:window.t("Stop Price"),className:"tv-data-table__cell--right-align",property:"stopPrice",formatter:"formatPrice"},{label:window.t("Take Profit"),className:"tv-data-table__cell--right-align",property:"takeProfit",formatter:"formatPrice"},{label:window.t("Stop Loss"),className:"tv-data-table__cell--right-align",property:"stopLoss",formatter:"formatPrice"},{label:window.t("Avg Fill Price"),className:"tv-data-table__cell--right-align",property:"avgPrice",formatter:"formatPrice",supportedStatusFilters:[0,6,2]},{id:"status",label:window.t("Status"),className:"",property:"status",formatter:"status",supportedStatusFilters:[0]},{label:window.t("Update Time"),className:"",property:"updateTime",formatter:"localDate"},{label:window.t("Order id"),className:"",property:"id"},{label:window.t("Expiry"),className:"",property:"expiry"},{label:window.t("Expiry Time"),className:"tv-data-table__cell--right-align",property:"expiryTime",formatter:"localDateOrDateTime"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"orderSettings",notSortable:!0,modificationProperty:"status"}]),a=[{label:window.t("Symbol"),className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:window.t("Side"),className:"",property:"side",formatter:"side"},{label:window.t("Type"),className:"",property:"type",formatter:"type"},{label:window.t("Qty"),className:"tv-data-table__cell--right-align",property:"qty",formatter:"formatQuantity",help:window.t("Size in lots")},{
label:window.t("Limit Price"),className:"tv-data-table__cell--right-align",property:"limitPrice",formatter:"formatPrice"},{label:window.t("Stop Price"),className:"tv-data-table__cell--right-align",property:"stopPrice",formatter:"formatPrice"},{label:window.t("Take Profit"),className:"tv-data-table__cell--right-align",property:"takeProfit",formatter:"formatPriceForexSup"},{label:window.t("Stop Loss"),className:"tv-data-table__cell--right-align",property:"stopLoss",formatter:"formatPriceForexSup"},{id:"status",label:window.t("Status"),className:"",property:"status",formatter:"status"},{label:window.t("Update Time"),className:"",property:"updateTime",formatter:"localDate"},{label:window.t("Order id"),className:"",property:"id"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"orderSettings",notSortable:!0,modificationProperty:"status"}],u=(window.t("Balance"),window.t("Equity",{context:"trading"}),window.t("Total Profit"),[{label:window.t("Symbol"),className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:window.t("Side"),className:"",property:"side",formatter:"side"},{label:window.t("Qty"),className:"tv-data-table__cell--right-align",property:"qty",formatter:"formatQuantity",help:window.t("Size in lots")},{label:window.t("Avg Fill Price"),className:"tv-data-table__cell--right-align",property:"avgPrice",formatter:"avgPriceFormatter"},{label:window.t("Take Profit"),className:"tv-data-table__cell--right-align",property:"takeProfit",formatter:"formatPriceForexSup"},{label:window.t("Stop Loss"),className:"tv-data-table__cell--right-align",property:"stopLoss",formatter:"formatPriceForexSup"},{label:window.t("Profit"),className:"tv-data-table__cell--right-align",property:"unrealizedPl",formatter:"profit",fixedWidth:!0},{label:window.t("Position id"),className:"",property:"id"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"posSettings",notSortable:!0,modificationProperty:"status"}]),c=[{label:window.t("Symbol"),className:"",property:"symbol"},{label:window.t("Currency name"),className:"",property:"longName",notSortable:!0},{label:window.t("Total"),className:"tv-data-table__cell--right-align",property:"total",formatter:"variablePrecision",fixedWidth:!0},{label:window.t("Available"),className:"tv-data-table__cell--right-align",property:"available",formatter:"variablePrecision",fixedWidth:!0},{label:window.t("Reserved"),className:"tv-data-table__cell--right-align",property:"reserved",formatter:"variablePrecision",fixedWidth:!0},{label:window.t("BTC value"),className:"tv-data-table__cell--right-align",property:"btcValue",formatter:"variablePrecision",fixedWidth:!0},{label:window.t("Value"),property:"value",className:"tv-data-table__cell--right-align",formatter:"cryptoValueInCurrencyFormatter",fixedWidth:!0}],l=r("Eyy1"),h=r("4qhP"),p=r("24R9"),d=(r("bZMm"),r("brCa"),window.t("Failed to fetch"));!function(t){t[t.Get=1]="Get",t[t.Post=2]="Post",t[t.Put=3]="Put",t[t.Delete=4]="Delete"}(i||(i={}));var _=function(t){function e(e,r){
var i=t.call(this,e)||this;return i.name="MessageExtractorResult",i.userFriendlyMessage=r,i}return Object(s.__extends)(e,t),e}(Error);function f(t){var e={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.tradingview.com/chart/OlHDdzUm/"};return t&&(e.Authorization="Bearer "+t),e}function g(t,e,r,o,n){return void 0===r&&(r=i.Get),Object(s.__awaiter)(this,void 0,void 0,(function(){var a,u,c,l;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:a=o?Object(p.a)(o):o,u={method:i[r],headers:f(e)},a&&r!==i.Get&&(u.body=a),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,fetch(t,u)];case 2:if(!(c=s.sent()).ok)throw new Error(c.statusText);return[2,c];case 3:throw(l=s.sent()).message=Object(h.getErrorMessage)(l),n&&n.logError(l.message),l;case 4:return[2]}}))}))}function m(t,e,r,o,n){return void 0===r&&(r=i.Get),Object(s.__awaiter)(this,void 0,void 0,(function(){var i,a;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return[4,g(t,e,r,o,n)];case 1:return[4,s.sent().json()];case 2:if(!function(t){return!(!t||t.hasOwnProperty("s")&&"error"===t.s)}(i=s.sent()))throw a=i.errmsg?i.errmsg:d,n&&n.logError(a),new Error(a);return[2,i]}}))}))}function y(t,e,r,o,n){return void 0===r&&(r=i.Get),Object(s.__awaiter)(this,void 0,void 0,(function(){var i;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return[4,m(t,e,r,o,n)];case 1:return[2,(i=s.sent()).d?i.d:i]}}))}))}function b(t,e,r){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,y(t,void 0,i.Post,{login:e,password:r,locale:window.locale})];case 1:return[2,s.sent()];case 2:throw s.sent();case 3:return[2]}}))}))}function v(t){return{valid:!0,data:t}}function w(t,e,r,o,n,a){return void 0===n&&(n=v),Object(s.__awaiter)(this,void 0,void 0,(function(){var u,c,l,h,p,d;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:u={method:i[e],headers:r},s.label=1;case 1:return s.trys.push([1,7,,8]),null!==o&&(u.body=JSON.stringify(o)),[4,fetch(t,u)];case 2:return(c=s.sent()).ok?[3,5]:void 0===a?[3,4]:[4,a(c)];case 3:throw l=s.sent(),new _(l.logMessage,l.userFriendlyMessage);case 4:throw new _(c.statusText);case 5:return[4,c.json()];case 6:if(h=s.sent(),!(p=n(h)).valid)throw new Error(p.errormsg);return[2,p.data];case 7:throw d=s.sent(),new _(d.message,d.userFriendlyMessage);case 8:return[2]}}))}))}var O,P=r("e3/o"),S=r("txPx"),T=r("aIyQ"),k=r.n(T),C=Object(S.getLogger)("Trading.Requester"),A=function(){function t(t,e,r,i,s,o,n){this._currentPulseIndex=0,this._requestInterval=null,this._requestTimeOut=null,this._errorsCount=0,this._status=0,this._snapshot=!0,this._url=t,this._headers=r,this._method=e,this._body=i,this._requestInterval=s,this.update=new k.a,this.statusChanged=new k.a,this._extractResponseData=o,this._extractErrorMessage=n}return t.prototype.start=function(){return this._status=1,this._errorsCount=0,this._currentPulseIndex++,this._request()},
t.prototype.stop=function(){this._status=0,this._clearResetRequestTimeout()},t.prototype.pause=function(){this.stop()},t.prototype.unpause=function(){this.start()},t.prototype.status=function(){return this._status},t.prototype.changeUrl=function(t){Object(l.assert)(1!==this._status,"Cannot change URL: requester is running"),this._url=t},t.prototype.changeHeaders=function(t){Object(l.assert)(1!==this._status,"Cannot change headers: requester is running"),this._headers=t},t.prototype._request=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t,e,r,i,o;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:t=this._currentPulseIndex,Object(l.assert)(1===this._status,"Unable to request: requester is inactive"),s.label=1;case 1:return s.trys.push([1,3,4,7]),e=this._url,[4,w(this._url,this._method,this._headers,this._body,this._extractResponseData,this._extractErrorMessage)];case 2:return r=s.sent(),this._errorsCount=0,e===this._url&&1===this._status&&t===this._currentPulseIndex&&(this.update.fire(r,this._snapshot),this._snapshot=!1),[3,7];case 3:return i=s.sent(),o=Object(h.getErrorMessage)(i),C.logError(o+": "+this._url),this._errorsCount++,t===this._currentPulseIndex&&this._failOnErrorsCount(o),[3,7];case 4:return null===this._requestInterval||1!==this._status||t!==this._currentPulseIndex?[3,6]:[4,this._makeNextRequest()];case 5:s.sent(),s.label=6;case 6:return[7];case 7:return[2]}}))}))},t.prototype._clearResetRequestTimeout=function(){null!==this._requestTimeOut&&(clearTimeout(this._requestTimeOut),this._requestTimeOut=null)},t.prototype._failOnErrorsCount=function(t){this._errorsCount>20&&(this._clearResetRequestTimeout(),this._status=2,this.statusChanged.fire({requesterStatus:this._status,errorMessage:t}))},t.prototype._makeNextRequest=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t,e=this;return Object(s.__generator)(this,(function(r){return t=this._currentPulseIndex,this._requestTimeOut=null,this._requestTimeOut=setTimeout((function(){return Object(s.__awaiter)(e,void 0,void 0,(function(){return Object(s.__generator)(this,(function(e){switch(e.label){case 0:return t!==this._currentPulseIndex?[3,2]:[4,this._request()];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}),this._requestInterval),[2]}))}))},t}(),j=function(){function t(t,e,r,i,s,o,n,a,u,c){this.update=new k.a,this.statusChanged=new k.a,this._data=[],this._status=0,this._requester=new A(t,e,r,i,s,a,u),this._idField=o,this._keys=n,this._useDeepEquals=c}return t.prototype.start=function(){return this._status=1,this._requester.update.subscribe(this,this._onNewData),this._requester.statusChanged.subscribe(this,this._onStatusChanged),this._requester.start()},t.prototype.stop=function(){this._status=0,this._requester.update.unsubscribe(this,this._onNewData),this._requester.statusChanged.unsubscribe(this,this._onStatusChanged),this._requester.stop(),delete this._requester},t.prototype.pause=function(){this._status=0,this._requester.stop()},t.prototype.unpause=function(){this._status=1,
this._requester.start()},t.prototype.changeHeaders=function(t){this._requester.changeHeaders(t)},t.prototype._onNewData=function(t,e){if(1===this._status){var r=Object(h.findArraysDifferences)(this._data,t,this._idField,this._keys,this._useDeepEquals);(r.added.length>0||r.modified.length>0||r.removed.length>0)&&(this._data=t,this.update.fire(r,e))}},t.prototype._onStatusChanged=function(t){this._status=t.requesterStatus,this.statusChanged.fire({requesterStatus:t.requesterStatus,errorMessage:t.errorMessage})},t}(),D=(function(){function t(){}t.prototype.ready=function(){return Promise.resolve()},t.prototype.brokerToTv=function(t){return t},t.prototype.tvToBroker=function(t){return t}}(),r("ivNn")),q=r("E9hm");r.d(e,"Broker",(function(){return K}));var F={limit:1,market:2,stop:3,stoplimit:4},B=((O={})[1]="limit",O[2]="market",O[3]="stop",O[4]="stoplimit",O),x={placing:4,inactive:3,working:6,rejected:5,filled:2,cancelled:1},I=["qty","status","filledQty","avgPrice","limitPrice","stopPrice","parentId","duration"],R=["instrument","qty","side","avgPrice","unrealizedPl","realizedPl","stopLoss","takeProfit"],U=["available","total","btcValue"],E={checked:!1,text:""},M={history:500,positions:1e3,quotes:500,orders:500,accountManager:500,balances:1e3},V=window.t("This market is not tradable with this brokerage account. Switch to another account and try again");function N(t){return t.s&&"ok"!==t.s?{valid:!1,errormsg:t.errmsg}:{valid:!0,data:t.d}}function z(t){return"sell"===t?-1:1}function L(t){return void 0!==t.accountManager&&Array.isArray(t.accountManager)&&t.accountManager.length>0}function Q(t){return t.amData&&Array.isArray(t.amData)&&t.amData.length>0?t.amData:function(t){var e=Object(h.formatNumber)(t.balance),r=Object(h.formatNumber)(t.unrealizedPl);return[[[e,void 0!==t.equity?Object(h.formatNumber)(t.equity):Object(h.formatNumber)(t.balance+t.unrealizedPl),r]]]}(t)}function W(t,e){var r=2!==e.status&&1!==e.status,i=r?e.limitPrice:void 0,s=r?e.stopPrice:void 0;3===e.type?t.stopLoss=s:t.takeProfit=i}function H(t){return t.map((function(t){return{price:t[0],volume:t[1]}}))}function G(t){return Object.assign({id:t.symbol},t)}var K=function(){function t(t,e,r,i){var s,a=this;if(void 0===i&&(i=null),this._accounts=[],this._accountManagerTablesData=[],this._accountManagerTablesDelegates=[],this._cryptoBalances=[],this._oAuthAuthorizationProvider=null,this._requesters={},this._depthSubscriptions={},this._customFormatters=[],this._permittedSymbolSearchGroups=[],this._accessTokenExpirationTimeout=null,this._loginTasks=null,this._orderColumns=n,this._positionColumns=u,this._customFields={textWithCheckboxFieldMetaInfo:[],customComboBoxMetaInfo:[]},this._host=t,this._restUrl=s="/"===(s=e)[s.length-1]?s:s+"/",this._metainfo=Object.assign({},{configFlags:q.b},r),this._realtimeSubscriptions=new Set,this._pipValueSubscriptions=new Set,this._quotesSubscriptions=new Map,this._currentQuotes=new Map,this._priceFormatterCache=new Map,this._instruments=new Map,this._initData(),this._tokenStorageKey=String("rest-token"),
this._permittedSymbolSearchGroups=[Object(l.ensureDefined)(r.id)],this._lastAccountIdKey=String("rest-last-account-id-"+r.id),this._logger=t.getLogger(),this._status=this._host.factory.createWatchedValue(3),this._account=t.factory.createWatchedValue({id:"",name:"",currencySign:"",config:{},instruments:[],type:o.AccountType.Demo}),this._createMapper(),this._setAccountBinded=this._setAccount.bind(this),i){var c=Date.now()+432e6;this._saveAccessToken({access_token:i,expiration:c}),this._setAccessTokenExpirationTimeout(c)}this._createButtonDropdownOptions();var h=this._host.sellBuyButtonsVisibility();null!==h&&h.subscribe((function(){a._createButtonDropdownOptions()}));var p=this._host.domPanelVisibility();p&&p.subscribe((function(){a._createButtonDropdownOptions()}));var d=this._host.orderPanelVisibility();d&&d.subscribe((function(){a._createButtonDropdownOptions()})),this._customFormatters.push({name:"avgPriceFormatter",format:function(t){var e=a._priceFormatterCache.get(t.row.symbol);return void 0!==e?e.format(t.value):(a._logger.logWarn("Cannot find price formatter for symbol: "+t.row.symbol),String(t.value))}},{name:"cryptoValueInCurrencyFormatter",format:function(t){return t.row.value+" "+t.row.valueCurrency}}),this._cryptoBalanceTableChangeDelegate=this._host.factory.createDelegate()}return t.prototype.tryRestoreSession=function(){this._tryConnect()},t.prototype.chartContextMenuActions=function(t,e){return this._host.defaultContextMenuActions(t,e)},t.prototype.accountsMetainfo=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(t){return[2,this._accounts]}))}))},t.prototype.setCurrentAccount=function(t){var e=this._accounts.find((function(e){return e.id===t}));void 0!==e&&this._account.setValue(e)},t.prototype.accountManagerInfo=function(){var t=this,e=this._accountSummaryRowData.titles.map((function(e,r){return{text:e,wValue:t._accountSummaryRowData.values[r].readonly(),formatter:t._accountSummaryRowData.formatters[r]}})),r=[],i=this._ensuredConfigFlags().supportOrderBrackets||this._ensuredConfigFlags().supportPositionBrackets,s=this._ensuredConfigFlags().supportBalances;if(L(this._brokerConfig))if(s){var o=0!==this._cryptoBalances.length?Object.keys(this._cryptoBalances[0]):c.map((function(t){return t.property})),n=c.filter((function(t){return o.includes(t.property)})),u=Object.assign({},{id:"cryptoBalances",name:"Balances",getData:function(){return Promise.resolve(t._cryptoBalances.map((function(t){return G(t)})))},changeDelegate:this._cryptoBalanceTableChangeDelegate,columns:n});r.push(u)}else{var h=Object(l.ensure)(this._brokerConfig.accountManager).map((function(e,r){return Object.assign({},{id:e.id,name:void 0!==e.title&&e.title.length>0?e.title:window.t("Account Info"),getData:function(){return Promise.resolve(t._accountManagerTablesData[r])},changeDelegate:t._accountManagerTablesDelegates[r],columns:e.columns.map((function(t){return Object.assign({},{id:t.id,label:t.title,help:t.tooltip,property:t.id,formatter:t.formatter,
notSortable:!t.sortable,fixedWidth:t.fixedWidth,tooltip:t.tooltip})}))})}));r.push.apply(r,h)}var p=Object(l.ensureDefined)(this._metainfo),d=this._brokerConfig.durations&&this._brokerConfig.durations.some((function(t){return Boolean(t.hasDatePicker||t.hasTimePicker)})),_=function(t){return i||"stopLoss"!==t.property&&"takeProfit"!==t.property},f=void 0!==p.customPositionColumnTitles&&p.customPositionColumnTitles.length>0?this._positionColumns.map((function(t){var e=Object(l.ensureDefined)(p.customPositionColumnTitles).find((function(e){return void 0!==t.property&&e.hasOwnProperty(t.property)}));return t.label=void 0!==e?e[Object(l.ensureDefined)(t.property)]:t.label,t})):this._positionColumns,g={accountTitle:Object(l.ensure)(this._metainfo.title),orderColumns:this._orderColumns.filter(_).filter((function(e){return t._brokerConfig.durations||"expiry"!==e.property})).filter((function(t){return d||"expiryTime"!==t.property})).filter((function(e){return t._ensuredConfigFlags().supportPartialOrderExecution||"filledQty"!==e.property})),pages:[{id:"summary",title:$.t("Account Summary"),tables:r}],positionColumns:f.filter(_).filter((function(e){return t._ensuredConfigFlags().supportMultiposition||"id"!==e.property})),summary:e,customFormatters:this._customFormatters};return this._ensuredConfigFlags().supportOrdersHistory&&(g.historyColumns=a.filter(_)),g},t.prototype.currentAccount=function(){return this._account.value().id},t.prototype.currentAccountType=function(){return 0!==this._accounts.length?this._accounts.some((function(t){return t.type===o.AccountType.Live}))?o.AccountType.Live:o.AccountType.Demo:void 0},t.prototype.executions=function(t){return Promise.resolve(this._tvExecutions.filter((function(e){return e.symbol===t})))},t.prototype.orders=function(){return Promise.resolve(this._tvOrders)},t.prototype.ordersHistory=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t,e=this;return Object(s.__generator)(this,(function(r){switch(r.label){case 0:return[4,this._getOrdersHistoryByAccountId(this._account.value().id)];case 1:return t=r.sent(),[2,Promise.resolve(t.map((function(t){return e._orderToTV(t)})))]}}))}))},t.prototype.positions=function(){return Promise.resolve(this._tvPositions)},t.prototype.cancelOrder=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(e){return[2,y(this._getOrderIdRestUrl(t),this._getAccessToken(),i.Delete)]}))}))},t.prototype.modifyOrder=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r;return Object(s.__generator)(this,(function(i){return 2===t.parentType?void 0===this._tvPositionById(t.parentId)?[2]:(e=this._getPositionBracketsById(t.parentId),[2,this.editPositionBrackets(Object(l.ensure)(t.brokerSymbol),{takeProfit:t.limitPrice||e.takeProfit,stopLoss:t.stopPrice||e.stopLoss})]):1===t.parentType?[2,2!==(r=this._tvOrderById(Object(l.ensure)(t.parentId))).status?this.modifyOrder(Object(s.__assign)(Object(s.__assign)({},r),{stopLoss:t.stopPrice,takeProfit:t.limitPrice
})):this._modifySingleOrder(t)]:[2,this._modifySingleOrder(t)]}))}))},t.prototype.placeOrder=function(t){var e;return Object(s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,n;return Object(s.__generator)(this,(function(s){return r=this._ensuredConfigFlags().supportDigitalSignature,i=null,t.customFields&&(r&&(o=(null===(e=t.customFields)||void 0===e?void 0:e.digitalSignature)||this._getDigitalSignatureState(),i=o.text,this._setDigitalSignatureState(t.customFields.digitalSignature),this._makeDigitalSignatureCustomFields()),this._host.patchOrderDialogOptions({customFields:this._getCustomFields()})),delete(n=Object.assign({},t.customFields)).digitalSignature,[2,this._placeOrder(t,i,n)]}))}))},t.prototype.cancelOrders=function(t,e,r){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t=this;return Object(s.__generator)(this,(function(e){return[2,function(){return Promise.all(r.map((function(e){return t.cancelOrder(e)}))).then((function(){}))}()]}))}))},t.prototype.editPositionBrackets=function(t,e){var r=this._getPositionIdRestUrl(t),s=Object.assign({},e);return y(r,this._getAccessToken(),i.Put,s)},t.prototype.reversePosition=function(t,e){var r=this._getPositionIdRestUrl(t),s=this._tvPositionById(t);if(void 0===s)throw new Error("Failed to reverse position: Position "+t+" not found");var o=1===s.side?"sell":"buy",n=Object.assign({side:o},e);return y(r,this._getAccessToken(),i.Put,n)},t.prototype.closePosition=function(t){return y(this._getPositionIdRestUrl(t),this._getAccessToken(),i.Delete)},t.prototype.isTradable=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r,i,o;return Object(s.__generator)(this,(function(s){return null!==(e=this._mapFromTV(t))?(r=this._instruments.has(e),i={tradable:r},r||null!==(o=this._getAccountWithTradableSymbol(e))&&(i.solutions={changeAccount:o.id},i.shortReason=V,i.reason="<p>"+V+"</p>"),[2,i]):[2,{tradable:!1}]}))}))},t.prototype.subscribeRealtime=function(t){var e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.add(e),this._subscribeQuotes(e)):this._logger.logError(Object(h.getErrorMessage)("Symbol not found"))},t.prototype.unsubscribeRealtime=function(t){var e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError(Object(h.getErrorMessage)("Symbol not found"))},t.prototype.subscribePipValue=function(t){var e=this._mapFromTV(t);if(null!==e){if(!this._instrumentInfo(e).hasQuotes)return;this._pipValueSubscriptions.add(e),this._subscribeQuotes(e)}else this._logger.logError(Object(h.getErrorMessage)("Symbol not found"))},t.prototype.unsubscribePipValue=function(t){var e=this._mapFromTV(t);null!==e?this._pipValueSubscriptions.has(e)&&(this._pipValueSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError(Object(h.getErrorMessage)("Symbol not found"))},t.prototype.subscribeDOME=function(t){var e=this._mapFromTV(t);if(null!==e){var r=this._getDepthUrl(e),s=new A(r,i.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),N),o=this._onDepthUpdate.bind(this,t)
;s.update.subscribe(this,o),s.start(),this._depthSubscriptions[t]={callback:o,requester:s}}else this._logger.logError(Object(h.getErrorMessage)("Symbol not found"))},t.prototype.unsubscribeDOME=function(t){try{this._depthSubscriptions[t].requester.update.unsubscribe(this,this._depthSubscriptions[t].callback),this._depthSubscriptions[t].requester.stop(),delete this._depthSubscriptions[t]}catch(e){this._logger.logError(Object(h.getErrorMessage)(e))}},t.prototype.signIn=function(t,e,r){return Object(s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,n=this;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:this._setStatus(2),this._host.credentialsStorage.clear(this._tokenStorageKey),s.label=1;case 1:return s.trys.push([1,3,,4]),r=function(){return n._authorize(t,e).then((function(t){n._saveAccessToken(t),n._setAccessTokenExpirationTimeout(t.expiration)}))},[4,this._setAndStartLoginTasks(r)];case 2:return s.sent(),this._createButtonDropdownOptions(),this._setStatus(1),[3,4];case 3:return i=s.sent(),o=Object(h.getErrorMessage)(i),this._logger.logError("Failed to connect to broker: "+o),this._setStatus(4,{message:o}),this._disconnect(),[3,4];case 4:return[2]}}))}))},t.prototype.symbolInfo=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e;return Object(s.__generator)(this,(function(r){if(null!==(e=this._mapFromTV(t)))return[2,this._instrumentInfo(e)];throw new Error("Symbol not found")}))}))},t.prototype.connectionStatus=function(){return this._status.value()},t.prototype.disconnect=function(t){return void 0===t&&(t=!1),Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(e){switch(e.label){case 0:return this._disconnect(t),null===this._loginTasks?[3,2]:[4,this._loginTasks.terminate()];case 1:e.sent(),e.label=2;case 2:return this._setStatus(3,{message:void 0,disconnectType:o.DisconnectType.LogOut}),[2]}}))}))},t.prototype.supportFloatingPanel=function(){return!0},t.prototype.getRealtimeDataCheckParams=function(){return{token:this._getAccessToken()}},t.prototype.getVerifyLiveAccountParams=function(){return{token:this._getAccessToken()}},t.prototype.unhideSymbolSearchGroups=function(){return this._permittedSymbolSearchGroups},t.prototype.spreadFormatter=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r;return Object(s.__generator)(this,(function(i){if(null!==(e=this._mapFromTV(t)))return void 0===(r=this._instruments.get(e))||"forex"!==r.type&&"cfd"!==r.type?[2,this._host.defaultFormatter(t,!1)]:[2,this._host.numericFormatter(1)];throw new Error("Symbol not found")}))}))},t.prototype.quantityFormatter=function(t){var e=this._mapFromTV(t);if(null!==e){var r=this._instruments.get(e);if(void 0!==r&&"crypto"===r.type)return this._host.quantityFormatter(8)}return this._host.quantityFormatter()},t.prototype._setAccount=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r,i,o,n,a,u,c;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return e=1===this.connectionStatus(),
this._cleanup(),e&&this._setStatus(2),this._saveAccountId(t),this._account.setValue(t),r=t.durations?t.durations:this._originalBrokerConfig.durations,this._brokerConfig=Object.assign({},this._originalBrokerConfig,t.ui,{durations:r}),this._metainfo.configFlags=Object.assign(this._metainfo.configFlags,t.config),this._host.patchConfig(Object(l.ensureDefined)(this._metainfo.configFlags)),this._makeAccountSummaryRowData(),[4,this._initRequesters()];case 1:for(s.sent(),i=0,o=t.instruments;i<o.length;i++)n=o[i],this._instruments.set(n.name,n);return[4,this._getAccountState()];case 2:for(a=s.sent(),u=0;u<Object(l.ensure)(this._brokerConfig.accountManager).length;u++)c=this._host.factory.createDelegate(),this._accountManagerTablesDelegates.push(c),this._accountManagerTablesData.push([{}]);return this._setAccountManagerTableData(Q(a)),this._setAccountSummaryRowData(a),this._brokerConfig.durations&&this._host.setDurations(function(t){for(var e=[],r=0,i=t;r<i.length;r++){var s=i[r],o={name:s.title,value:s.id,hasDatePicker:s.hasDatePicker,hasTimePicker:s.hasTimePicker};"default"in s&&(o.default=s.default),e.push(o)}return e}(this._brokerConfig.durations)),t.orderDialogCustomFields&&this._makeOrderDialogCustomFields(t.orderDialogCustomFields),this._ensuredConfigFlags().supportDigitalSignature&&this._makeDigitalSignatureCustomFields(),this._host.patchOrderDialogOptions({customFields:this._getCustomFields()}),this._changeQuotesRequesterUrl(),e&&this._setStatus(1),[2]}}))}))},t.prototype._setAndStartLoginTasks=function(t){var e=this,r=Object(s.__spreadArrays)([function(){return e._getBrokerConfig().then((function(t){e._originalBrokerConfig=t}))}],this._initializeAccountTasks());return t&&r.unshift(t),this._loginTasks=new h.TasksWithTermination(r),this._loginTasks.execute()},t.prototype._createOAuthAuthorizationProvider=function(t){var e,r={brokerId:Object(l.ensureDefined)(this._metainfo.id),environmentType:t,logger:this._logger};return this._isOAuthImplicitFlowAuthType()?e=new OAuth2ImplicitFlowWithRenewTokenAuthorizationProvider(r):(r.passRedirectUrl=!0,e=new OAuth2CodeFlowAuthorizationProvider(r)),e},t.prototype._instrumentInfo=function(t){var e=this._instruments.get(t);if(!e)throw new Error("Instrument not found");var r={qty:{min:e.minQty||1,max:e.maxQty||1e9,step:e.qtyStep||1},pipValue:e.pipValue||1,pipSize:e.pipSize||.01,minTick:e.minTick||.01,description:e.description,brokerSymbol:t,hasQuotes:!e.hasOwnProperty("hasQuotes")||Boolean(e.hasQuotes)};return e.hasOwnProperty("lotSize")&&(r.lotSize=e.lotSize),e.hasOwnProperty("stopPriceStep")&&(r.stopPriceStep=e.stopPriceStep),e.hasOwnProperty("limitPriceStep")&&(r.limitPriceStep=e.limitPriceStep),"type"in e&&(r.type=e.type),"marginRate"in e&&(r.marginRate=e.marginRate),"baseCurrency"in e&&(r.baseCurrency=e.baseCurrency),"quoteCurrency"in e&&(r.quoteCurrency=e.quoteCurrency),r},t.prototype._subscribeQuotes=function(t){var e=this._quotesSubscriptions.get(t),r=void 0===e?1:e+1;this._quotesSubscriptions.set(t,r),1===r&&this._changeQuotesRequesterUrl()},
t.prototype._unsubscribeQuotes=function(t){var e=this._quotesSubscriptions.get(t);if(void 0!==e)return 1===e?(this._quotesSubscriptions.delete(t),void this._changeQuotesRequesterUrl()):void this._quotesSubscriptions.set(t,e-1)},t.prototype._disconnect=function(t){void 0===t&&(t=!1),this._isOAuthAuthorizationType()&&this._cleanAndDestroyOauthAuthorizationProvider(),this._cleanup(),this._cleanAccessTokenExpirationTimeout(),!1===t&&this._host.credentialsStorage.clear(this._tokenStorageKey),this._account.unsubscribe(this._setAccountBinded)},t.prototype._getAccessToken=function(){return this._accessToken},t.prototype._initializeAccountTasks=function(){var t=this,e=[];return e.push((function(){return t._getAccounts().then((function(e){t._accounts=e}))})),e.push((function(){return Promise.all(t._accounts.map((function(e){return t._getInstrumentsByAccountId(e.id).then((function(t){e.instruments=t}))})))})),this._ensuredConfigFlags().supportUnhideSymbolSearchGroups&&e.push((function(){return t._getPermittedSymbolSearchGroups().then((function(e){t._permittedSymbolSearchGroups=e}))})),e.push((function(){return t._mapper.ready()})),e.push((function(){var e=t._getLastAccount(),r=void 0!==e?e:t._accounts[0];return r.config.supportOrderCustomFields&&t._brokerConfig.orderCustomFields&&(t._orderColumns=t._mergeCustomFieldColumns(n,Object(l.ensureDefined)(t._brokerConfig.orderCustomFields))),r.config.supportPositionCustomFields&&t._brokerConfig.positionCustomFields&&(t._positionColumns=t._mergeCustomFieldColumns(u,Object(l.ensureDefined)(t._brokerConfig.positionCustomFields))),t._setAccountBinded(r).then((function(){return t._account.subscribe(t._setAccountBinded)}))})),e},t.prototype._onQuotesUpdate=function(t){for(var e=0,r=t;e<r.length;e++){var i=r[e];if("ok"===i.s){var s=i.n,o=this._mapToTV(s);if(null!==o){var n=i.v;n.lp=n.lp||0,n.ch=n.ch||0,n.chp=n.chp||0;var a=this._instruments.get(s);if(void 0===a)throw new Error("Instrument "+s+" not found");"forex"!==a.type&&"cfd"!==a.type||void 0===a.pipSize||(n.spread=Object(D.fixComputationError)((n.ask-n.bid)/a.pipSize)),n.buyPipValue&&n.sellPipValue&&this._pipValueSubscriptions.has(s)&&(this._host.pipValueUpdate(o,{buyPipValue:n.buyPipValue,sellPipValue:n.sellPipValue}),a.pipValue=n.buyPipValue),this._currentQuotes.set(o,{ask:n.ask,bid:n.bid}),this._host.realtimeUpdate(o,n)}else this._logger.logError("Cannot map symbol")}}},t.prototype._changeQuotesRequesterUrl=function(){var t=this._getQuotesUrl();void 0!==this._requesters.quotes&&this._requesters.quotes.stop(),null!==t&&(void 0===this._requesters.quotes?(this._requesters.quotes=new A(t,i.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),N),this._requesters.quotes.update.subscribe(this,this._onQuotesUpdate)):this._requesters.quotes.changeUrl(t),this._requesters.quotes.start())},t.prototype._stopRequester=function(t){void 0!==t&&(t.stop(),t.update.unsubscribeAll(this))},t.prototype._requestExecutions=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r,o,n,a,u
;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return[4,w(this._getExecutionsUrl(t),i.Get,this._getHeaders(),null,N)];case 1:e=s.sent(),r=Object(h.findArraysDifferences)(this._restExecutions,e,"id",["id"]),o=0,n=r.added,s.label=2;case 2:return o<n.length?(a=n[o],this._restExecutions.push(a),[4,this._executionToTv(a)]):[3,5];case 3:u=s.sent(),this._tvExecutions.push(u),this._host.executionUpdate(u),s.label=4;case 4:return o++,[3,2];case 5:return[2]}}))}))},t.prototype._createMapper=function(){this._mapper=this._host.createMapperSync(this._metainfo.id,this.unhideSymbolSearchGroups())},t.prototype._updateExecutionsBySymbols=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e=this;return Object(s.__generator)(this,(function(r){return Promise.all(t.map((function(t){return e._requestExecutions(t)}))),[2]}))}))},t.prototype._setAccountSummaryRowData=function(t){var e=t.hasOwnProperty("equity")&&void 0!==t.equity?t.equity:t.balance+t.unrealizedPl;if(this._ensuredConfigFlags().supportCustomAccountSummaryRow)for(var r=Object(l.ensureDefined)(t.accountSummaryRowData),i=0;i<r.length;i++)this._accountSummaryRowData.values[i].setValue(r[i]);else this._accountSummaryRowData.values[0].setValue(t.balance),this._accountSummaryRowData.values[1].setValue(e),this._accountSummaryRowData.values[2].setValue(t.unrealizedPl);isFinite(e)&&this._host.equityUpdate(e)},t.prototype._setAccountManagerTableData=function(t){if(0!==this._accountManagerTablesData.length)for(var e=0;e<t.length;e++){var r=t[e],i=this._accountManagerTablesData[e],s=Object(l.ensure)(this._brokerConfig.accountManager)[e].columns;i.length=r.length;for(var o=0;o<r.length;o++){for(var n=r[o],a={id:o},u=0;u<n.length;u++){a[Object(l.ensure)(s[u].id)]=n[u]}i[o]=a,this._accountManagerTablesDelegates[e].fire(a)}}},t.prototype._createRequesters=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t,e,r,o,n,a,u;return Object(s.__generator)(this,(function(s){return t=this._getOrdersRestUrl(),e=this._getAccountStateRestUrl(),this._requesters={orders:new j(t,i.Get,this._getHeaders(),null,this._getPullingInterval("orders"),"id",I,N,void 0,!0),accountState:new A(e,i.Get,this._getHeaders(),null,this._getPullingInterval("accountManager"),N)},this._ensuredConfigFlags().supportPositions&&(r=this._getPositionsRestUrl(),(o=new j(r,i.Get,this._getHeaders(),null,this._getPullingInterval("positions"),"id",R,N)).update.subscribe(this,this._onPositionsUpdate),o.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.positions=o),this._ensuredConfigFlags().supportBalances&&(n=this._getBalancesRestUrl(),(a=new A(n,i.Get,this._getHeaders(),null,this._getPullingInterval("balances"),N)).update.subscribe(this,this._onCryptoBalancesUpdate),a.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.balances=a),(u=Object(l.ensure)(this._requesters.orders)).update.subscribe(this,this._onOrdersUpdate),u.statusChanged.subscribe(this,this._onRequesterStatusUpdate),
Object(l.ensure)(this._requesters.accountState).update.subscribe(this,this._onAccountStateUpdate),[2]}))}))},t.prototype._startRequesters=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t,e=this;return Object(s.__generator)(this,(function(r){switch(r.label){case 0:return t=[],Object.keys(this._requesters).forEach((function(r){return t.push(Object(l.ensure)(e._requesters[r]).start())})),[4,Promise.all(t)];case 1:return r.sent(),this._logger.logInfo("Requesters started"),[2]}}))}))},t.prototype._stopAndDeleteRequesters=function(){var t=this;Object.keys(this._requesters).forEach((function(e){var r=t._requesters[e];void 0!==r&&t._stopRequester(r)})),this._requesters={}},t.prototype._changeRequestersHeaders=function(){var t=this;Object.keys(this._requesters).forEach((function(e){var r=Object(l.ensure)(t._requesters[e]);r.pause(),r.changeHeaders(t._getHeaders()),r.unpause()}))},t.prototype._cleanup=function(){this._stopAndDeleteRequesters(),this._initData()},t.prototype._setStatus=function(t,e){this._status.value()!==t&&(this._status.setValue(t),this._host.connectionStatusUpdate(t,e))},t.prototype._onRequesterStatusUpdate=function(t){2===t.requesterStatus&&(this._setStatus(4,{message:t.errorMessage}),this._disconnect(!0),this._tryConnect())},t.prototype._onAccountStateUpdate=function(t){this._setAccountSummaryRowData(t);var e=Q(t);this._setAccountManagerTableData(e)},t.prototype._onCryptoBalancesUpdate=function(t){var e=this,r=Object(h.findArraysDifferences)(this._cryptoBalances,t,"symbol",U);Object(s.__spreadArrays)(r.added,r.modified).forEach((function(t){var r=e._cryptoBalanceIndexBySymbol(t.symbol);-1!==r?e._cryptoBalances[r]=t:e._cryptoBalances.push(t);var i=G(t);e._cryptoBalanceTableChangeDelegate.fire(i),e._host.cryptoBalanceUpdate(t.symbol,t)})),r.removed.forEach((function(t){var r=e._cryptoBalanceIndexBySymbol(t.symbol);if(-1!==r){var i=Object.assign({},t,{total:0,available:0,btcValue:0});e._cryptoBalances[r]=i;var s=G(i);e._cryptoBalanceTableChangeDelegate.fire(s)}}))},t.prototype._cryptoBalanceIndexBySymbol=function(t){return this._cryptoBalances.findIndex((function(e){return e.symbol===t}))},t.prototype._tryConnect=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t,e,r;return Object(s.__generator)(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),(t=this._getStoredAuthResult())?(this._accessToken=t.access_token,this._setStatus(2),[4,this._setAndStartLoginTasks()]):[3,2];case 1:i.sent(),this._setAccessTokenExpirationTimeout(t.expiration),this._createButtonDropdownOptions(),this._setStatus(1),i.label=2;case 2:return[3,4];case 3:return e=i.sent(),r=Object(h.getErrorMessage)(e),this._logger.logError(r),this._setStatus(3,{message:r,disconnectType:o.DisconnectType.FailedRestoring}),this._disconnect(),[3,4];case 4:return[2]}}))}))},t.prototype._mergeCustomFieldColumns=function(t,e){for(var r=t.slice(),i=t.map((function(t){return t.property})),s=0,o=e;s<o.length;s++){var n=o[s]
;if(n.id in i)this._logger.logWarn("Failed to add custom column. Column with id "+n.id+" already exists.");else{var a=n.id,u={label:n.title,property:a,help:n.tooltip,notSortable:!0,className:"right"===n.alignment?"tv-data-table__cell--right-align":""};r.splice(-1,0,u)}}return r},t.prototype._authorize=function(t,e){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(r){return[2,b(this._getAuthorizeUrl(),t,e)]}))}))},t.prototype._getAccounts=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t,e,r,i,n;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return[4,y(this._getAccountsUrl(),this._getAccessToken())];case 1:for(t=s.sent(),e=this._metainfo.defaultAccountType||o.AccountType.Demo,r=0,i=t;r<i.length;r++)(n=i[r]).currency=n.currency||"",n.currencySign=n.currencySign||"",n.type=n.type||e;return[2,t]}}))}))},t.prototype._getInstrumentsByAccountId=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(e){return[2,y(this._getInstrumentsUrlByAccountId(t),this._getAccessToken())]}))}))},t.prototype._getOrdersHistoryByAccountId=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(e){return[2,y(this._getOrdersHistoryUrlByAccountId(t),this._getAccessToken())]}))}))},t.prototype._getPermittedSymbolSearchGroups=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t;return Object(s.__generator)(this,(function(e){switch(e.label){case 0:return[4,y(this._getPermissionsUrl(),this._getAccessToken())];case 1:return[2,(t=e.sent()).hasOwnProperty("groups")?t.groups:this._metainfo.id]}}))}))},t.prototype._getBrokerConfig=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){var t;return Object(s.__generator)(this,(function(e){switch(e.label){case 0:return[4,y(this._getBrokerConfigUrl(),this._getAccessToken())];case 1:return L(t=e.sent())||(t.accountManager=[{id:"accountSummary",title:"",columns:[{id:"balance",title:window.t("Balance"),tooltip:"",fixedWidth:!0,sortable:!1},{id:"equity",title:window.t("Equity"),tooltip:"",fixedWidth:!0,sortable:!1},{id:"profit",title:window.t("Profit"),tooltip:"",fixedWidth:!0,sortable:!1}]}]),[2,t]}}))}))},t.prototype._getAccountState=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(t){return[2,y(this._getAccountStateUrl(),this._getAccessToken())]}))}))},t.prototype._placeOrder=function(t,e,r){var s=this._orderFromTV(t),o=this._getOrdersRestUrl()+"?requestId="+Object(P.randomHashN)(10);null!==e&&(s.digitalSignature=e);var n=Object.assign(r,s);return y(o,this._getAccessToken(),i.Post,n)},t.prototype._modifyOrder=function(t,e,r){return Object(s.__awaiter)(this,void 0,void 0,(function(){var o,n,a,u;return Object(s.__generator)(this,(function(s){return o={id:t.id,qty:t.qty},t.parent||(t.stopLoss&&(o.stopLoss=t.stopLoss),t.takeProfit&&(o.takeProfit=t.takeProfit)),
void 0!==t.duration&&(o.durationType=t.duration.type,void 0!==t.duration.datetime&&(o.durationDateTime=Math.trunc(t.duration.datetime/1e3))),void 0!==(n=this._currentQuotes.get(t.symbol))&&(o.currentAsk=n.ask,o.currentBid=n.bid),o.limitPrice=(t.type,t.limitPrice),o.stopPrice=(t.type,t.stopPrice),a=this._getOrderIdRestUrl(t.id),null!==e&&(o.digitalSignature=e),u=Object.assign(r,o),[2,y(a,this._getAccessToken(),i.Put,u)]}))}))},t.prototype._modifySingleOrder=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r,i,o;return Object(s.__generator)(this,(function(s){return e=this._ensuredConfigFlags().supportDigitalSignature,r=t.customFields&&t.customFields.digitalSignature?t.customFields.digitalSignature:this._getDigitalSignatureState(),null!==(i=e?r.text:null)&&(this._setDigitalSignatureState(r),this._makeDigitalSignatureCustomFields(),this._host.patchOrderDialogOptions({customFields:this._getCustomFields()})),delete(o=Object.assign({},t.customFields)).digitalSignature,[2,this._modifyOrder(t,i,o)]}))}))},t.prototype._createTvOrders=function(t){var e=this;return t.map((function(t){return e._orderToTV(t)}))},t.prototype._onOrdersUpdate=function(t){var e,r,i=this._createTvOrders(t.added),s=this._createTvOrders(t.modified),o=[];(e=this._restOrders).push.apply(e,t.added);for(var n=0,a=t.modified;n<a.length;n++){var u=a[n];this._restOrders[this._restOrderIndexById(u.id)]=u}(r=this._tvOrders).push.apply(r,i),o.push.apply(o,i);for(var c=0,l=s;c<l.length;c++){var h=l[c];this._tvOrders[this._tvOrderIndexById(h.id)]=h,o.push(h)}for(var p=0,d=o;p<d.length;p++){if(1===(u=d[p]).parentType){var _=this._tvOrderById(u.parentId);_&&(W(_,u),this._host.orderUpdate(_))}else if(2===u.parentType){var f=this._tvPositionById(u.parentId);if(f&&f.qty>0){W(f,u);var g=f.stopLoss,m=f.takeProfit;this._host.positionPartialUpdate(f.id,{stopLoss:g,takeProfit:m})}}else if(!u.parentType){var y=this._getOrderBrackets(u.id);y.stopLoss&&(u.stopLoss=y.stopLoss),y.takeProfit&&(u.takeProfit=y.takeProfit)}this._host.orderUpdate(u)}},t.prototype._createTVPositions=function(t){var e=this;return Promise.all(t.map((function(t){return e._positionToTV(t)})))},t.prototype._onPositionsUpdate=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r,i,o,n,a,u,c,h,p,d,_,f,g,m=this;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return e=[],[4,this._createTVPositions(t.added)];case 1:return r=s.sent(),[4,this._createTVPositions(t.modified)];case 2:for(i=s.sent(),o=0,n=t.added;o<n.length;o++)c=n[o],this._addOrModifyPosition(c,this._restPositions);for(a=0,u=t.modified;a<u.length;a++)c=u[a],this._restPositions[this._restPositionIndexById(c.id)]=c;return[4,Promise.all(r.map((function(t){return m._updatePriceFormatterCacheForSymbol(t.symbol)})))];case 3:for(s.sent(),h=0,p=r;h<p.length;h++)f=p[h],this._addOrModifyPosition(f,this._tvPositions),this._updatePositionBrackets(f),this._host.positionUpdate(f),this._host.plUpdate(f.id,f.unrealizedPl),e.push(Object(l.ensureDefined)(f.brokerSymbol));for(d=0,
_=i;d<_.length;d++){if(f=_[d],void 0===(g=this._tvPositionById(f.id)))return[2];this._updatePositionBrackets(f),this._host.positionUpdate(f),g.unrealizedPl!==f.unrealizedPl&&(this._host.plUpdate(f.id,f.unrealizedPl),this._host.positionPartialUpdate(f.id,{unrealizedPl:f.unrealizedPl})),g.side===f.side&&g.qty===f.qty||e.push(Object(l.ensureDefined)(f.brokerSymbol)),this._addOrModifyPosition(f,this._tvPositions)}return t.removed.forEach((function(t){var e=m._tvPositionById(t.id);if(void 0!==e){var r=m._restPositionById(t.id);e.qty=0,r.qty=0,m._host.positionUpdate(e)}})),this._ensuredConfigFlags().supportExecutions&&this._updateExecutionsBySymbols(e),[2]}}))}))},t.prototype._updatePositionBrackets=function(t){this._findPositionBracketOrders(t.id).forEach((function(e){return W(t,e)}))},t.prototype._addOrModifyPosition=function(t,e){var r=e.findIndex((function(e){return e.id===t.id}));-1!==r?e[r]=t:e.push(t)},t.prototype._restPositionIndexById=function(t){return this._restPositions.findIndex((function(e){return e.id===t}))},t.prototype._restPositionById=function(t){var e=this._restPositions.find((function(e){return e.id===t}));if(!e)throw new Error("Cannot find REST position: "+t);return e},t.prototype._restOrderIndexById=function(t){return this._restOrders.findIndex((function(e){return e.id===t}))},t.prototype._tvPositionById=function(t){return this._tvPositions.find((function(e){return e.id===t}))},t.prototype._tvOrderIndexById=function(t){return this._tvOrders.findIndex((function(e){return e.id===t}))},t.prototype._tvOrderById=function(t){var e=this._tvOrders.find((function(e){return e.id===t}));if(!e)throw new Error("Cannot find TV order");return e},t.prototype._getBaseRestUrl=function(){var t=this._account.value().id;return Object(l.assert)(!!t,"Unable to get base url - account is not properly initialized"),this._getBaseRestUrlByAccountId(t)},t.prototype._getBaseRestUrlByAccountId=function(t){return this._restUrl+"accounts/"+encodeURIComponent(t)},t.prototype._getAccountStateRestUrl=function(){return this._getBaseRestUrl()+"/state?locale="+window.locale},t.prototype._getExecutionsUrl=function(t){return this._getBaseRestUrl()+"/executions?instrument="+encodeURIComponent(t)},t.prototype._getPullingInterval=function(t){var e=M[t];if(this._brokerConfig.hasOwnProperty("pullingInterval")&&void 0!==this._brokerConfig.pullingInterval){var r=this._brokerConfig.pullingInterval;r.hasOwnProperty(t)&&(e=r[t])}return e},t.prototype._getAuthorizeUrl=function(){return this._restUrl+"authorize"},t.prototype._getBrokerConfigUrl=function(){return this._restUrl+"config?locale="+window.locale},t.prototype._getAccountsUrl=function(){return this._restUrl+"accounts"},t.prototype._getAccountStateUrl=function(){return this._getBaseRestUrl()+"/state?locale="+window.locale},t.prototype._getQuotesUrl=function(){var t=this,e=Array.from(this._quotesSubscriptions.keys()).filter((function(e){return t._instruments.has(e)}))
;return 0===e.length?null:this._restUrl+"quotes?symbols="+encodeURIComponent(e.join(","))+"&accountId="+encodeURIComponent(this._account.value().id)},t.prototype._getDepthUrl=function(t){return this._restUrl+"depth?symbol="+encodeURIComponent(t)},t.prototype._getInstrumentsUrlByAccountId=function(t){return this._getBaseRestUrlByAccountId(t)+"/instruments/"},t.prototype._getOrdersHistoryUrlByAccountId=function(t){return this._getBaseRestUrlByAccountId(t)+"/ordersHistory/?maxCount=200"},t.prototype._getPermissionsUrl=function(){return this._restUrl+"permissions"},t.prototype._getOrdersRestUrl=function(){return this._getBaseRestUrl()+"/orders/"},t.prototype._getOrderIdRestUrl=function(t){return this._getBaseRestUrl()+"/orders/"+t},t.prototype._getPositionsRestUrl=function(){return this._getBaseRestUrl()+"/positions/"},t.prototype._getPositionIdRestUrl=function(t){return this._getBaseRestUrl()+"/positions/"+t},t.prototype._getBalancesRestUrl=function(){return this._getBaseRestUrl()+"/balances/"},t.prototype._getHeaders=function(){return f(this._getAccessToken())},t.prototype._orderToTV=function(t){var e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);var r,i,s={id:t.id,type:(i=t.type,F[i=i||"market"]),side:z(t.side),symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),filledQty:t.filledQty,status:(r=t.status,x[r]),avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice};if(t.parentId&&(s.parentId=t.parentId,s.parentType=this._getOrderParentType(t.parentType)),t.stopLoss&&(s.stopLoss=t.stopLoss),t.takeProfit&&(s.takeProfit=t.takeProfit),t.duration){s.duration={type:t.duration.type};var o=this._getOrderDuration(t.duration);if(Object(l.assert)(void 0!==o,"Order duration is not in durations list. Please check the broker or account duration configuration"),s.expiry=void 0!==o?o.title:t.duration.type,t.duration.hasOwnProperty("datetime")&&void 0!==t.duration.datetime){var n=1e3*t.duration.datetime;s.duration.datetime=n,s.expiryTime={dateOrDateTime:n,hasTime:Object(l.ensureDefined)(o).hasTimePicker}}}return void 0!==t.message&&(Object(h.isOrderOrPositionMessageType)(t.message.type)?s.message=t.message:this._logger.logError("Order message type '"+t.message.type+"' is not supported")),void 0!==t.lastModified&&(s.updateTime=1e3*t.lastModified),this._mergeCustomFields(t,s),s},t.prototype._mergeCustomFields=function(t,e){if(void 0!==t.customFields)for(var r=0,i=t.customFields;r<i.length;r++){var s=i[r];e[s.id]=s.value}},t.prototype._getOrderParentType=function(t){return"position"===t?2:1},t.prototype._getOrderDuration=function(t){return Object(l.ensureDefined)(this._brokerConfig.durations).find((function(e){return e.id===Object(l.ensureDefined)(t).type}))},t.prototype._orderFromTV=function(t){var e,r,i=this._mapFromTV(t.symbol);if(null!==i){var s={instrument:i,qty:t.qty,side:(r=t.side,-1===r?"sell":"buy"),type:(e=t.type,B[e=e||2]),limitPrice:t.limitPrice,stopPrice:t.stopPrice};t.stopLoss&&(s.stopLoss=t.stopLoss),t.takeProfit&&(s.takeProfit=t.takeProfit),
t.duration&&(s.durationType=t.duration.type,t.duration.datetime&&(s.durationDateTime=Math.trunc(t.duration.datetime/1e3)));var o=this._currentQuotes.get(t.symbol);return void 0!==o&&(s.currentAsk=o.ask,s.currentBid=o.bid),s}throw new Error("Cannot map symbol: "+t.symbol)},t.prototype._getOrderBrackets=function(t){for(var e={},r=0,i=this._tvOrders.filter((function(e){return 1===e.parentType&&e.parentId===t&&1!==e.status}));r<i.length;r++){var s=i[r];3===s.type&&(e.stopLoss=s.stopPrice),1===s.type&&(e.takeProfit=s.limitPrice)}return e},t.prototype._findPositionBracketOrders=function(t){return this._tvOrders.filter((function(e){return 2===e.parentType&&e.parentId===t&&6===e.status}))},t.prototype._getPositionBracketsById=function(t){for(var e={},r=0,i=this._findPositionBracketOrders(t);r<i.length;r++){var s=i[r];3===s.type&&(e.stopLoss=s.stopPrice),1===s.type&&(e.takeProfit=s.limitPrice)}return e},t.prototype._executionToTv=function(t){var e=this._mapToTV(t.instrument);return null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument),{id:t.id,symbol:e||"",brokerSymbol:t.instrument,price:t.price,qty:t.qty,side:z(t.side),time:1e3*t.time}},t.prototype._positionToTV=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r;return Object(s.__generator)(this,(function(i){return null===(e=this._mapToTV(t.instrument))&&this._logger.logWarn("Cannot map symbol: "+t.instrument),r={id:t.id,symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),side:"buy"===t.side?1:-1,avgPrice:t.avgPrice,unrealizedPl:t.unrealizedPl,realizedPl:t.realizedPl},void 0!==t.message&&(Object(h.isOrderOrPositionMessageType)(t.message.type)?r.message=t.message:this._logger.logError("Position message type '"+t.message.type+"' is not supported")),this._ensuredConfigFlags().supportPartialOrderExecution&&(r.filledQty=t.filledQty),this._tvOrders.filter((function(t){return 2===t.parentType&&t.parentId===r.id})).forEach((function(t){return W(r,t)})),this._mergeCustomFields(t,r),[2,r]}))}))},t.prototype._mapToTV=function(t){return this._mapper.brokerToTv(t)},t.prototype._mapFromTV=function(t){return this._mapper.tvToBroker(t)},t.prototype._initData=function(){this._accountManagerTablesDelegates=[],this._accountManagerTablesData=[],this._restExecutions=[],this._tvExecutions=[],this._restOrders=[],this._tvOrders=[],this._restPositions=[],this._tvPositions=[],this._instruments.clear(),this._priceFormatterCache.clear(),this._currentQuotes.clear(),this._cryptoBalances=[],this._accountSummaryRowData={titles:[],values:[],formatters:[]}},t.prototype._createButtonDropdownOptions=function(){var t={showSellBuyButtons:!0,showDOM:!0,showOrderPanel:!0,tradingProperties:!0,selectAnotherBroker:(!0,!1),disconnect:(!0,!1)},e=this._host.defaultDropdownMenuActions(t);this._host.setButtonDropdownActions(e)},t.prototype._initRequesters=function(){return Object(s.__awaiter)(this,void 0,void 0,(function(){return Object(s.__generator)(this,(function(t){switch(t.label){case 0:return this._accounts.length>0?[4,this._createRequesters()]:[3,3];case 1:
return t.sent(),[4,this._startRequesters()];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))},t.prototype._getStoredAuthResult=function(){return this._host.credentialsStorage.load(this._tokenStorageKey)},t.prototype._setAccessTokenExpirationTimeout=function(t){if(null!==t){var e,r=this._checkAccessTokenExpiration.bind(this);(e=1e3*Object(l.ensureDefined)(t)-Date.now().valueOf())<0?this._checkAccessTokenExpiration():(r=this._checkAccessTokenExpiration.bind(this),e+=1e4,this._accessTokenExpirationTimeout=setTimeout(r,e))}},t.prototype._saveAccessToken=function(t){this._host.credentialsStorage.save(this._tokenStorageKey,t),this._accessToken=t.access_token},t.prototype._checkAccessTokenExpiration=function(){var t=this._getStoredAuthResult();if(t&&1e3*Object(l.ensureNotNull)(t.expiration)<=Date.now().valueOf()){var e=window.t("Access token has expired");this._logger.logError(e),this._setStatus(4,{message:e,disconnectType:o.DisconnectType.LogOut}),this._disconnect()}},t.prototype._onDepthUpdate=function(t,e){var r={snapshot:!0,asks:H(e.asks),bids:H(e.bids)};this._host.domeUpdate(t,r)},t.prototype._getAccountWithTradableSymbol=function(t){for(var e=null,r=0,i=this._accounts;r<i.length;r++){var s=i[r];if(-1!==s.instruments.findIndex((function(e){return t===e.name}))){e=s;break}}return e},t.prototype._createPriceFormatter=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,r,i;return Object(s.__generator)(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,this._host.symbolSnapshot(t)];case 1:return e=s.sent(),i=e.fractional?e.minmov:1,r=this._host.factory.createPriceFormatter(e.pricescale,i,Boolean(e.fractional),e.minmove2),[3,3];case 2:return s.sent(),this._logger.logWarn("Failed to create price formatter for symbol "+t+"."),r=this._host.factory.createPriceFormatter(),[3,3];case 3:return[2,r]}}))}))},t.prototype._updatePriceFormatterCacheForSymbol=function(t){return Object(s.__awaiter)(this,void 0,void 0,(function(){var e;return Object(s.__generator)(this,(function(r){switch(r.label){case 0:return this._priceFormatterCache.has(t)?[3,2]:[4,this._createPriceFormatter(t)];case 1:e=r.sent(),this._priceFormatterCache.set(t,e),r.label=2;case 2:return[2]}}))}))},t.prototype._getAccountById=function(t){return this._accounts.find((function(e){return e.id===t}))},t.prototype._saveAccountId=function(t){this._host.settings.save(this._lastAccountIdKey,JSON.stringify(t.id))},t.prototype._getLastAccount=function(){var t=this._host.settings.load(this._lastAccountIdKey,void 0);return void 0!==t?this._getAccountById(JSON.parse(t)):void 0},t.prototype._isOAuthAuthorizationType=function(){return this._isOAuthCodeFlowAuthType()||this._isOAuthImplicitFlowAuthType()},t.prototype._isOAuthImplicitFlowAuthType=function(){return"oauth2-implicit-flow"===this._ensuredConfigFlags().authorizationType},t.prototype._isOAuthCodeFlowAuthType=function(){return"oauth2-code-flow"===this._ensuredConfigFlags().authorizationType},t.prototype._makeDigitalSignatureCustomFields=function(){
var t=this._customFields.textWithCheckboxFieldMetaInfo.find((function(t){return"digitalSignature"===t.id}));if(t)t.value=this._getDigitalSignatureState();else{var e={inputType:"TextWithCheckBox",id:"digitalSignature",title:window.t("Digital Signature"),placeHolder:window.t("Enter your personal digital signature"),value:this._getDigitalSignatureState(),customInfo:{checkboxTitle:window.t("Save"),asterix:!0}};this._customFields.textWithCheckboxFieldMetaInfo.push(e)}},t.prototype._setDigitalSignatureState=function(t){var e=t.checked?t:E;this._host.credentialsStorage.save("digital-signature-state",e)},t.prototype._getDigitalSignatureState=function(){var t=this._host.credentialsStorage.load("digital-signature-state");return null!==t?t:E},t.prototype._makeAccountSummaryRowData=function(){var t=[],e=[],r=[];if(this._ensuredConfigFlags().supportCustomAccountSummaryRow&&void 0!==this._brokerConfig.accountSummaryRow)for(var i=0,s=this._brokerConfig.accountSummaryRow;i<s.length;i++){var o=s[i];t.push(o.title),e.push(this._host.factory.createWatchedValue()),r.push("default")}else t=[window.t("Account Balance"),window.t("Equity",{context:"trading"}),window.t("Profit")],e=[this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue()],r.fill("fixed",0,2);this._accountSummaryRowData.titles=t,this._accountSummaryRowData.values=e,this._accountSummaryRowData.formatters=r},t.prototype._cleanAccessTokenExpirationTimeout=function(){null!==this._accessTokenExpirationTimeout&&(clearTimeout(this._accessTokenExpirationTimeout),this._accessTokenExpirationTimeout=null)},t.prototype._cleanAndDestroyOauthAuthorizationProvider=function(){null!==this._oAuthAuthorizationProvider&&(this._oAuthAuthorizationProvider.renewTokenDelegate().unsubscribe(this,this._onRenewAccessTokenHandler),this._oAuthAuthorizationProvider.destroy(),this._oAuthAuthorizationProvider=null)},t.prototype._onRenewAccessTokenHandler=function(t){if(null===t)return this._setStatus(3),void this._disconnect();this._saveAccessToken(t),this._changeRequestersHeaders()},t.prototype._ensuredConfigFlags=function(){return Object(l.ensureDefined)(this._metainfo.configFlags)},t.prototype._makeOrderDialogCustomFields=function(t){var e;if(t.comboBox){this._customFields.customComboBoxMetaInfo.length&&(this._customFields.customComboBoxMetaInfo.length=0);var r=t.comboBox.map((function(t){return Object(s.__assign)(Object(s.__assign)({},t),{inputType:"ComboBox"})}));(e=this._customFields.customComboBoxMetaInfo).push.apply(e,r)}},t.prototype._getCustomFields=function(){return Object(s.__spreadArrays)(this._customFields.textWithCheckboxFieldMetaInfo,this._customFields.customComboBoxMetaInfo)},t}()}}]);